<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Listado de Canciones - Evento Musical N¬∫8</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: #eee;
      margin: 10px;
    }
    h1 {
      margin-bottom: 8px;
    }
    input[type="text"] {
      width: 100%;
      max-width: 400px;
      padding: 8px;
      margin-top: 5px;
      margin-bottom: 15px;
      border-radius: 6px;
      border: 1.5px solid #b62222;
      background: #221010;
      color: #eee;
      font-size: 1em;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #aa2b2b;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    th {
      color: #d02121;
      border-bottom: 2px solid #d02121;
    }
    button {
      background: #d02121;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background: #960909;
    }
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.6);
    }
    .modal-content {
      background-color: #2a1a1a;
      margin: 10% auto;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
      color: #eee;
      box-shadow: 0 0 10px #d02121;
      font-family: Arial, sans-serif;
    }
    .modal-content label,
    .modal-content input {
      display: block;
      width: 100%;
      margin-bottom: 15px;
      font-size: 1.2em;
    }
    .modal-content input[type="number"] {
      padding: 8px;
      border-radius: 6px;
      border: 1.5px solid #b62222;
      background: #221010;
      color: #eee;
      font-size: 1em;
      box-sizing: border-box;
    }
    .modal-footer {
      text-align: right;
    }
    .modal-footer button {
      margin-left: 10px;
      font-size: 1em;
      padding: 8px 16px;
    }
  </style>
</head>
<body>
<h1>Listado de Canciones - Evento Musical N¬∫8</h1>
<label for="buscador">üîç Buscar canci√≥n o artista:</label>
<input type="text" id="buscador" placeholder="Escribe para filtrar..." />

<div id="mensaje">Cargando listado desde Google Sheet...</div>
<div id="tabla-container"></div>

<!-- Modal para votar -->
<div id="modalVotar" class="modal">
  <div class="modal-content">
    <h3>Votar canci√≥n</h3>
    <p id="modal-info"></p>
    <label for="input-voto">Ingresa un n√∫mero (1-10):</label>
    <input type="number" id="input-voto" min="1" max="10" />
    <div class="modal-footer">
      <button id="cancelarBtn">Cancelar</button>
      <button id="confirmarBtn">Enviar voto</button>
    </div>
  </div>
</div>

<script>
const GAS_URL_CANCIONES = "https://script.google.com/macros/s/AKfycbw4TCbkUleFKLYE352VI7jSSVjQIED42CneWDfrTmLZURZxOyJzPKYqFwjfxbuk69sWgw/exec";

let listadoGlobal = [];
let cancionSeleccionada = null;
let textoBusqueda = "";

function abrirModal() {
  document.getElementById("modalVotar").style.display = "block";
}
function cerrarModal() {
  document.getElementById("modalVotar").style.display = "none";
  document.getElementById("input-voto").value = "";
}

document.getElementById("cancelarBtn").addEventListener("click", cerrarModal);

document.getElementById("confirmarBtn").addEventListener("click", () => {
  const input = document.getElementById("input-voto");
  const votoNum = parseInt(input.value);
  if (isNaN(votoNum) || votoNum < 1 || votoNum > 10) {
    alert("Debe ingresar un n√∫mero entre 1 y 10.");
    return;
  }
  if (!cancionSeleccionada) {
    alert("Error: Canci√≥n no seleccionada.");
    cerrarModal();
    return;
  }
  enviarVoto(cancionSeleccionada.artista, cancionSeleccionada.tema, votoNum);
  cerrarModal();
});

function callbackCanciones(json) {
  listadoGlobal = json;
  renderizarListado(json);
}

function renderizarListado(json) {
  const mensaje = document.getElementById("mensaje");
  const contenedor = document.getElementById("tabla-container");

  if (!Array.isArray(json)) {
    mensaje.textContent = "Formato inesperado al cargar datos";
    return;
  }
  if (json.length === 0) {
    mensaje.textContent = "No hay canciones en la hoja.";
    contenedor.innerHTML = "";
    return;
  }

  mensaje.textContent = `Total canciones: ${json.length}`;

  // Filtrar por texto de b√∫squeda
  const filtrado = json.filter(c => {
    const texto = (c.artista + " " + c.tema).toLowerCase();
    return texto.includes(textoBusqueda.toLowerCase());
  });

  // Agrupar por artista
  const agrupado = {};
  filtrado.forEach(c => {
    const artista = c.artista || "Desconocido";
    if (!agrupado[artista]) agrupado[artista] = [];
    agrupado[artista].push(c);
  });

  contenedor.innerHTML = "";

  Object.keys(agrupado)
    .sort((a, b) => a.localeCompare(b, 'es'))
    .forEach((artista) => {
      const titulo = document.createElement("h2");
      titulo.textContent = artista;
      titulo.style.color = "#d02121";
      titulo.style.borderBottom = "1px solid #d02121";
      titulo.style.marginTop = "25px";
      contenedor.appendChild(titulo);

      const totalVotos = agrupado[artista].reduce((acc, c) => acc + (parseInt(c.votos) || 0), 0);
      const subtitulo = document.createElement("div");
      subtitulo.textContent = `Total de votos: ${totalVotos}`;
      subtitulo.style.color = "#bbb";
      subtitulo.style.marginBottom = "8px";
      subtitulo.style.fontStyle = "italic";
      contenedor.appendChild(subtitulo);

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const trHead = document.createElement("tr");
      ["#", "Tema", "Votos", "Reproducir", "Votar"].forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      agrupado[artista].forEach((c, idx) => {
        const globalIndex = listadoGlobal.indexOf(c);
        const tr = document.createElement("tr");

        const tdIndex = document.createElement("td");
        tdIndex.textContent = idx + 1;
        tr.appendChild(tdIndex);

        const tdTema = document.createElement("td");
        tdTema.textContent = c.tema || "";
        tr.appendChild(tdTema);

        const tdVotos = document.createElement("td");
        tdVotos.id = `votos-${globalIndex}`;
        tdVotos.textContent = c.votos || 0;
        tr.appendChild(tdVotos);

        const tdReproducir = document.createElement("td");
        const btnReproducir = document.createElement("button");
        btnReproducir.textContent = "‚ñ∂";
        btnReproducir.addEventListener("click", () => {
          reproducir(c.url || "", c.artista || "", c.tema || "");
        });
        tdReproducir.appendChild(btnReproducir);
        tr.appendChild(tdReproducir);

        const tdVotar = document.createElement("td");
        const btnVotar = document.createElement("button");
        btnVotar.textContent = "Votar";
        btnVotar.addEventListener("click", () => abrirModalVoto(globalIndex));
        tdVotar.appendChild(btnVotar);
        tr.appendChild(tdVotar);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      contenedor.appendChild(table);
    });

  if (Object.keys(agrupado).length === 0) {
    contenedor.innerHTML = "<p>No hay coincidencias con la b√∫squeda.</p>";
  }
}

function cargarDatosJSONP() {
  const script = document.createElement("script");
  script.src = GAS_URL_CANCIONES + "?action=getListado&callback=callbackCanciones";
  document.body.appendChild(script);
}

function reproducir(url, artista, tema) {
  if (url) window.open(url, "_blank");
  else {
    const q = [artista, tema].filter(Boolean).join(" ").trim();
    if (!q) alert("No hay datos suficientes para reproducir la canci√≥n.");
    else window.open("https://www.youtube.com/results?search_query=" + encodeURIComponent(q), "_blank");
  }
}

function abrirModalVoto(idx) {
  cancionSeleccionada = listadoGlobal[idx];
  document.getElementById("modal-info").textContent = `Canci√≥n: "${cancionSeleccionada.tema}" de "${cancionSeleccionada.artista}"`;
  abrirModal();
}

function enviarVoto(artista, tema, voto) {
  const data = new URLSearchParams({ artista, tema, voto });
  fetch(GAS_URL_CANCIONES, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: data.toString(),
  })
    .then(res => res.json())
    .then(resp => {
      if (resp.status === "OK") {
        alert("Voto registrado correctamente.");
        for (let i = 0; i < listadoGlobal.length; i++) {
          if (listadoGlobal[i].artista === artista && listadoGlobal[i].tema === tema) {
            listadoGlobal[i].votos = (parseInt(listadoGlobal[i].votos) || 0) + parseInt(voto);
            break;
          }
        }
        renderizarListado(listadoGlobal);
      } else {
        alert("Error al registrar voto: " + resp.message);
      }
    })
    .catch(() => alert("Error enviando voto."));
}

document.getElementById("buscador").addEventListener("input", (e) => {
  textoBusqueda = e.target.value;
  renderizarListado(listadoGlobal);
});

window.onload = cargarDatosJSONP;
</script>
</body>
</html>
