<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Listado de Canciones - Evento Musical Nº8</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: #eee;
      margin: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #aa2b2b;
      text-align: left;
    }
    th {
      color: #d02121;
      border-bottom: 2px solid #d02121;
    }
    button {
      background: #d02121;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background: #960909;
    }
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.6);
    }
    .modal-content {
      background-color: #2a1a1a;
      margin: 10% auto;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
      color: #eee;
      box-shadow: 0 0 10px #d02121;
      font-family: Arial, sans-serif;
    }
    .modal-content label,
    .modal-content input {
      display: block;
      width: 100%;
      margin-bottom: 15px;
      font-size: 1.2em;
    }
    .modal-content input[type="number"] {
      padding: 8px;
      border-radius: 6px;
      border: 1.5px solid #b62222;
      background: #221010;
      color: #eee;
      font-size: 1em;
      box-sizing: border-box;
    }
    .modal-footer {
      text-align: right;
    }
    .modal-footer button {
      margin-left: 10px;
      font-size: 1em;
      padding: 8px 16px;
    }
  </style>
</head>
<body>
<h1>Listado de Canciones - Evento Musical Nº8</h1>
<div id="mensaje">Cargando listado desde Google Sheet...</div>
<div id="tabla-container"></div>

<!-- Modal para votar -->
<div id="modalVotar" class="modal">
  <div class="modal-content">
    <h3>Votar canción</h3>
    <p id="modal-info"></p>
    <label for="input-voto">Ingresa un número (1-10):</label>
    <input type="number" id="input-voto" min="1" max="10" />
    <div class="modal-footer">
      <button id="cancelarBtn">Cancelar</button>
      <button id="confirmarBtn">Enviar voto</button>
    </div>
  </div>
</div>

<script>
  const GAS_URL_CANCIONES = "https://script.google.com/macros/s/AKfycbw4TCbkUleFKLYE352VI7jSSVjQIED42CneWDfrTmLZURZxOyJzPKYqFwjfxbuk69sWgw/exec";

  let listadoGlobal = [];
  let cancionSeleccionada = null;

  // Mostrar modal
  function abrirModal() {
    document.getElementById("modalVotar").style.display = "block";
  }
  // Ocultar modal
  function cerrarModal() {
    document.getElementById("modalVotar").style.display = "none";
    document.getElementById("input-voto").value = "";
  }

  document.getElementById("cancelarBtn").addEventListener("click", cerrarModal);

  // Confirmar voto
  document.getElementById("confirmarBtn").addEventListener("click", () => {
    const input = document.getElementById("input-voto");
    const votoNum = parseInt(input.value);
    if (isNaN(votoNum) || votoNum < 1 || votoNum > 10) {
      alert("Debe ingresar un número entre 1 y 10.");
      return;
    }
    if (!cancionSeleccionada) {
      alert("Error: Canción no seleccionada.");
      cerrarModal();
      return;
    }
    enviarVoto(cancionSeleccionada.artista, cancionSeleccionada.tema, votoNum);
    cerrarModal();
  });

  // Función callback del JSONP
  function callbackCanciones(json) {
    listadoGlobal = json; // guardamos globalmente para actualizar votos visualmente
    const mensaje = document.getElementById("mensaje");
    const contenedor = document.getElementById("tabla-container");
    if (!Array.isArray(json)) {
      mensaje.textContent = "Formato inesperado al cargar datos";
      return;
    }
    if (json.length === 0) {
      mensaje.textContent = "No hay canciones en la hoja.";
      return;
    }
    mensaje.textContent = `Total canciones: ${json.length}`;

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const trHead = document.createElement("tr");
    ["#", "Artista", "Tema", "Votos", "Reproducir", "Votar"].forEach(h => {
      const th = document.createElement("th");
      th.textContent = h;
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    json.forEach((c, idx) => {
      let artista = c.artista || "";
      let tema = c.tema || "";
      let votos = c.votos || 0;
      let url = c.url || "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${artista}</td>
        <td>${tema}</td>
        <td id="votos-${idx}">${votos}</td>
        <td>
          <button type="button"
                  class="btn-reproducir"
                  data-url="${url}"
                  data-artista="${encodeURIComponent(artista)}"
                  data-tema="${encodeURIComponent(tema)}">▶</button>
        </td>
        <td><button type="button" onclick="abrirModalVoto(${idx})">Votar</button></td>
      `;
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    contenedor.innerHTML = "";
    contenedor.appendChild(table);

    // Agregar listeners a los botones reproducir
    document.querySelectorAll('.btn-reproducir').forEach(btn => {
      btn.addEventListener('click', () => {
        const url = btn.dataset.url;
        const artista = decodeURIComponent(btn.dataset.artista);
        const tema = decodeURIComponent(btn.dataset.tema);

        if (url) {
          window.open(url, "_blank");
        } else {
          let q = [artista, tema].filter(Boolean).join(" ").trim();
          q = q.replace(/['"&?#\/\\+%]/g, ""); // eliminar caracteres problemáticos
          if (q) window.open("https://www.youtube.com/results?search_query=" + encodeURIComponent(q), "_blank");
          else alert("No hay datos suficientes para reproducir la canción.");
        }
      });
    });
  }

  // Cargar datos con JSONP
  function cargarDatosJSONP() {
    const script = document.createElement("script");
    script.src = GAS_URL_CANCIONES + "?action=getListado&callback=callbackCanciones";
    document.body.appendChild(script);
  }

  // Abrir modal para votar una canción por índice
  function abrirModalVoto(idx) {
    cancionSeleccionada = listadoGlobal[idx];
    document.getElementById("modal-info").textContent = `Canción: "${cancionSeleccionada.tema}" de "${cancionSeleccionada.artista}"`;
    abrirModal();
  }

  // Enviar voto al backend y actualizar la tabla visualmente
  function enviarVoto(artista, tema, voto) {
    const data = new URLSearchParams({ artista, tema, voto });
    fetch(GAS_URL_CANCIONES, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: data.toString(),
    })
      .then((res) => res.json())
      .then((resp) => {
        if (resp.status === "OK") {
          alert("Voto registrado correctamente.");
          for (let i = 0; i < listadoGlobal.length; i++) {
            if (
              listadoGlobal[i].artista === artista &&
              listadoGlobal[i].tema === tema
            ) {
              listadoGlobal[i].votos =
                (parseInt(listadoGlobal[i].votos) || 0) + parseInt(voto);
              document.getElementById("votos-" + i).textContent =
                listadoGlobal[i].votos;
              break;
            }
          }
        } else {
          alert("Error al registrar voto: " + resp.message);
        }
      })
      .catch(() => alert("Error enviando voto."));
  }

  window.onload = cargarDatosJSONP;
</script>
</body>
</html>
